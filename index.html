/* --- index.html --- */
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Đăng nhập / Đăng ký</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <h2>Đăng nhập</h2>
    <input type="text" id="login-username" placeholder="Tên đăng nhập" />
    <input type="password" id="login-password" placeholder="Mật khẩu" />
    <button onclick="loginUser()">Đăng nhập</button>

    <hr />

    <h2>Đăng ký</h2>
    <input type="text" id="register-username" placeholder="Tên đăng nhập" />
    <input type="password" id="register-password" placeholder="Mật khẩu" />
    <button onclick="registerUser()">Đăng ký</button>
  </div>

  <script src="script.js"></script>
</body>
</html>

/* --- deposit.html --- */
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nạp tiền</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <h2>Tạo mã VietQR</h2>
    <input type="number" id="amount" placeholder="Nhập số tiền muốn nạp" />
    <button onclick="generateQR()">Tạo mã QR</button>
    <div id="qr-result"></div>
  </div>

  <script src="script.js"></script>
</body>
</html>

/* --- style.css --- */
body {
  font-family: sans-serif;
  background-image: url("https://png.pngtree.com/thumb_back/fw800/background/20240413/pngtree-mountain-s-and-lakes-beautiful-web-banner-design-for-header-image_15713989.jpg");
  background-size: cover;
  background-position: center;
  padding: 40px;
  text-align: center;
}

.container {
  background: rgba(255, 255, 255, 0.95);
  padding: 20px;
  max-width: 400px;
  margin: auto;
  border-radius: 12px;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
}

input {
  width: 100%;
  padding: 10px;
  margin-top: 10px;
  box-sizing: border-box;
  border-radius: 6px;
  border: 1px solid #ccc;
}

button {
  margin-top: 20px;
  padding: 10px 20px;
  cursor: pointer;
  border: none;
  background-color: #0070f3;
  color: white;
  border-radius: 6px;
}

#qr-result {
  margin-top: 20px;
}

/* --- script.js --- */
const SHEET_API = "https://sheetdb.io/api/v1/YOUR_API_ID";
const BANK_CODE = "ACB";
const ACCOUNT_NUMBER = "43146717";
const ACCOUNT_NAME = "DINH TAN HUY";

function getIP() {
  return fetch("https://api.ipify.org?format=json")
    .then(res => res.json())
    .then(data => data.ip)
    .catch(() => "unknown");
}

function registerUser() {
  const username = document.getElementById("register-username").value;
  const password = document.getElementById("register-password").value;

  fetch(`${SHEET_API}/search?username=${username}`)
    .then(res => res.json())
    .then(async users => {
      if (users.length > 0) return alert("Tên đăng nhập đã tồn tại!");
      const ip = await getIP();
      const userData = {
        data: {
          username,
          password,
          ip,
          total_nap: 0
        }
      };
      fetch(SHEET_API, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(userData)
      }).then(() => {
        alert("Đăng ký thành công!");
      });
    });
}

function loginUser() {
  const username = document.getElementById("login-username").value;
  const password = document.getElementById("login-password").value;

  fetch(`${SHEET_API}/search?username=${username}&password=${password}`)
    .then(res => res.json())
    .then(users => {
      if (users.length === 0) return alert("Sai thông tin đăng nhập!");
      localStorage.setItem("username", username);
      alert("Đăng nhập thành công!");
      window.location.href = "deposit.html";
    });
}

function generateRandomNote(length = 7) {
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
  let result = "";
  for (let i = 0; i < length; i++) {
    result += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return result;
}

function generateQR() {
  const amount = document.getElementById("amount").value;
  const username = localStorage.getItem("username");
  if (!username) return alert("Bạn chưa đăng nhập!");

  if (!amount || amount <= 0) {
    alert("Vui lòng nhập số tiền hợp lệ.");
    return;
  }

  const note = generateRandomNote();
  const encodedName = encodeURIComponent(ACCOUNT_NAME);
  const imageUrl = `https://img.vietqr.io/image/${BANK_CODE}-${ACCOUNT_NUMBER}-compact.png?amount=${amount}&addInfo=${note}&accountName=${encodedName}`;

  document.getElementById("qr-result").innerHTML = `
    <p><strong>Mã QR VietQR:</strong></p>
    <img src="${imageUrl}" alt="VietQR Code" />
    <p><strong>Nội dung CK:</strong> ${note}</p>
    <p><strong>Người nhận:</strong> ${ACCOUNT_NAME}</p>
    <p style="color: green; font-weight: bold;">✅ Đã tạo mã chuyển khoản thành công!</p>
  `;

  // Ghi log nạp vào sheet (cộng dồn)
  fetch(`${SHEET_API}/search?username=${username}`)
    .then(res => res.json())
    .then(users => {
      if (users.length === 0) return;
      const id = users[0].id;
      const currentTotal = parseFloat(users[0].total_nap || 0);
      const updateData = {
        data: { total_nap: currentTotal + parseFloat(amount) }
      };
      fetch(`${SHEET_API}/id/${id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(updateData)
      });
    });
}
